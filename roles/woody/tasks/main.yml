- name: Cron job - update discourse
  ansible.builtin.cron:
    name: 'update discourse'
    minute: '30'
    hour: '0'
    day: '1'
    job: 'cd /mnt/data/discourse && ./launcher rebuild app'

- name: Check discourse directory
  ansible.builtin.find:
    paths: /mnt/data/discourse
    file_type: any
  register: woody_discourse_install_directory

- name: Move discourse directory
  ansible.builtin.command: mv /mnt/data/discourse /mnt/data/discourse.bak
  args:
    removes: /mnt/data/discourse
    creates: /mnt/data/discourse.bak
  when: woody_discourse_install_directory.matched >= 1

- name: Git checkout discourse repository
  ansible.builtin.git:
    repo: https://github.com/discourse/discourse_docker.git
    dest: /mnt/data/discourse
    version: main

- name: Delete fresh discourse data
  ansible.builtin.file:
    path: '{{ item }}'
    state: absent
  when: woody_discourse_install_directory.matched >= 1
  with_items:
    - /mnt/data/discourse/containers
    - /mnt/data/discourse/shared

- name: Move discourse backups and configuration
  ansible.builtin.command:
    cmd: mv {{ item.src }} {{ item.dest }}
  when: woody_discourse_install_directory.matched >= 1
  changed_when: item.rc == 0
  with_items:
    - src: /mnt/data/discourse.bak/containers
      dest: /mnt/data/discourse
    - src: /mnt/data/discourse.bak/shared
      dest: /mnt/data/discourse

- name: Delete discourse temp directory
  ansible.builtin.file:
    path: /mnt/data/discourse.bak
    state: absent
  when: woody_discourse_install_directory.matched >= 1

- name: Boot discourse
  ansible.builtin.command:
    cmd: ./launcher rebuild app
    chdir: /mnt/data/discourse
  register: woody_discourse_boot
  changed_when: woody_discourse_boot.rc == 0
