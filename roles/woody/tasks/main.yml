- name: ðŸ“‚ Include Deploy Variables
  tags: [vars, woody]
  ansible.builtin.include_vars:
    file: ../secrets/deploy/vars.yml

- name: ðŸ“ Template Discourse Configuration
  tags: [discourse, config]
  ansible.builtin.template:
    src: "{{ woody_discourse_yaml_src }}"
    dest: "{{ woody_discourse_container_path }}/containers/{{ woody_discourse_container_name }}.yml"
    mode: "0600"
  notify:
    - build discourse

- name: ðŸ”„ Flush Handlers
  tags: [handlers]
  ansible.builtin.meta: flush_handlers

- name: ðŸ” Find Latest Discourse Backup
  tags: [backup, discourse]
  ansible.builtin.find:
    paths: "{{ woody_discourse_backup_dir }}"
    patterns: "*.tar.gz"
    file_type: file
    recurse: false
  register: woody_discourse_backups

- name: ðŸ•’ Set Latest Discourse Backup Fact
  tags: [backup, discourse]
  ansible.builtin.set_fact:
    woody_latest_discourse_backup: >-
      {{
        (
          woody_discourse_backups.files |
          sort(attribute='mtime', reverse=true) |
          first
        ).path
      }}
  when: woody_discourse_backups.files | length > 0

- name: â™»ï¸ Restore Discourse Backup
  tags: [discourse, backup]
  community.docker.docker_container_exec:
    container: "{{ woody_discourse_container_name }}"
    command: >
      bash -c "discourse enable_restore &&
               discourse restore {{ woody_latest_discourse_backup | basename }} &&
               discourse disable_restore"
  when: (woody_latest_discourse_backup | default(None)) is not none

- name: ðŸ”„ Restart Discourse Container
  tags: [discourse, docker]
  community.docker.docker_container:
    name: "{{ woody_discourse_container_name }}"
    restart: true
    state: started
  when: (woody_latest_discourse_backup | default(None)) is not none

- name: ðŸ” Find Latest GitLab Backup
  tags: [backup, gitlab]
  ansible.builtin.find:
    paths: "{{ woody_gitlab_backup_dir }}"
    patterns: "*.tar"
    file_type: file
    recurse: false
  register: woody_gitlab_backups

- name: ðŸ•’ Set Latest GitLab Backup Fact
  tags: [backup, gitlab]
  ansible.builtin.set_fact:
    woody_latest_gitlab_backup: >-
      {{
        (
          woody_gitlab_backups.files |
          sort(attribute='mtime', reverse=true) |
          first
        ).path |
        basename |
        regex_replace('_gitlab_backup\.tar$', '')
      }}
  when: woody_gitlab_backups.files | length > 0

- name: â³ Start GitLab Container & Wait
  tags: [gitlab, docker]
  community.docker.docker_compose_v2:
    project_src: "{{ common_docker_compose_directory }}"
    services: ["{{ woody_gitlab_container_name }}"]
    wait: true

- name: â™»ï¸ Restore GitLab Backup
  tags: [gitlab, backup]
  community.docker.docker_container_exec:
    container: "{{ woody_gitlab_container_name }}"
    command: >
      bash -c "gitlab-ctl stop puma &&
               gitlab-ctl stop sidekiq &&
               GITLAB_ASSUME_YES=1 gitlab-backup restore BACKUP={{ woody_latest_gitlab_backup }} &&
               gitlab-ctl reconfigure &&
               gitlab-ctl start"
  when: (woody_latest_gitlab_backup | default(None)) is not none

- name: ðŸ§¹ Clean Discourse & GitLab Backups
  tags: [backup, cleanup]
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ woody_gitlab_backups.files + woody_discourse_backups.files }}"
