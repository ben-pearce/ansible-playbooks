- name: ğŸ§° Install System Packages
  tags: [packages]
  ansible.builtin.apt:
    pkg:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
      - python3-pip
      - virtualenv
      - python3-setuptools
      - python3-docker
    state: present
    update_cache: true

- name: ğŸ” Check Docker Daemon Config
  tags: [docker, config]
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/roles/{{ inventory_hostname }}/files/docker/daemon.json"
  register: common_docker_daemon_config
  delegate_to: localhost
  become: false

- name: ğŸ“¦ Apply Docker Daemon Config If Present
  tags: [docker, config]
  when: common_docker_daemon_config.stat.exists
  block:
    - name: ğŸ“ Create Docker Config Directory
      tags: [docker, config]
      ansible.builtin.file:
        path: /etc/docker
        state: directory
        mode: "0755"

    - name: ğŸ“„ Copy Docker Daemon Config
      tags: [docker, config]
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/roles/{{ inventory_hostname }}/files/docker/daemon.json"
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: "0600"
        force: false

- name: ğŸ—ï¸ Add Docker Repository
  tags: [docker, packages]
  ansible.builtin.deb822_repository:
    name: docker
    types: [deb]
    uris: https://download.docker.com/linux/ubuntu
    suites: '{{ ansible_facts["distribution_release"] }}'
    components: [stable]
    signed_by: https://download.docker.com/linux/ubuntu/gpg
    state: present
    enabled: true

- name: ğŸ³ Install Docker Engine
  tags: [docker, packages]
  ansible.builtin.apt:
    pkg:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true

- name: ğŸ‘¤ Add User to Docker Group
  tags: [docker, user]
  ansible.builtin.user:
    name: '{{ ansible_facts["user_id"] }}'
    groups: ["docker"]
    append: true
