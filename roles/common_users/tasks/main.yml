- name: ðŸ‘¥ Add Users
  tags: [users, accounts]
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ item.groups | default(omit) }}"
    uid: "{{ item.uid }}"
    append: "{{ (item.groups is defined) | ternary(true, omit) }}"
    state: present
  loop: "{{ common_users_users | default([]) }}"

- name: ðŸ”‘ Copy Root SSH Keys
  tags: [ssh, root]
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /root/.ssh/
    owner: root
    group: root
    mode: "0600"
  with_fileglob:
    - ../../{{ inventory_hostname }}/secrets/ssh/root/*

- name: ðŸ” Collect User SSH Key Files
  tags: [ssh, users]
  ansible.builtin.set_fact:
    common_users_keys: >-
      {{
        common_users_keys | default([]) +
        [{'user': item.path, 'files': ssh_files}]
      }}
  vars:
    ssh_files: "{{ lookup('fileglob', item.root ~ item.path ~ '/*').split(',') }}"
  loop: "{{ lookup('community.general.filetree', '../../' ~ inventory_hostname ~ '/secrets/ssh/') }}"
  when: item.state == 'directory' and item.path not in ['root']

- name: ðŸ“ Ensure User SSH Dirs
  tags: [ssh, users]
  ansible.builtin.file:
    path: /home/{{ item }}/.ssh
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0700"
  loop: "{{ common_users_keys | default([]) | map(attribute='user') }}"

- name: ðŸ“¥ Copy User SSH Keys
  tags: [ssh, users]
  ansible.builtin.copy:
    src: "{{ item.1 }}"
    dest: /home/{{ item.0.user }}/.ssh/
    owner: "{{ item.0.user }}"
    group: "{{ item.0.user }}"
    mode: "0600"
  with_subelements:
    - "{{ common_users_keys | default([]) }}"
    - files

- name: ðŸ” Set Root Authorized Keys
  tags: [ssh, root]
  ansible.posix.authorized_key:
    user: root
    state: present
    key: '{{ lookup("file", item) }}'
  with_fileglob:
    - ../../{{ inventory_hostname }}/secrets/ssh/root/*.pub

- name: ðŸ” Set User Authorized Keys
  tags: [ssh, users]
  ansible.posix.authorized_key:
    user: "{{ item.0.user }}"
    state: present
    key: '{{ lookup("file", item.1) }}'
  when: item.1 is match('.*\.pub')
  with_subelements:
    - "{{ common_users_keys | default([]) }}"
    - files

- name: ðŸ· Add Known Hosts Entries
  tags: [ssh, knownhosts]
  become: true
  become_user: "{{ item.user }}"
  ansible.builtin.known_hosts:
    name: >-
      {%- if 'port' in item -%}
       [{{ item.host }}]:{{ item.port | default(22) }}
      {%- else -%}
       {{ item.host }}
      {%- endif -%}
    state: present
    path: >-
      {%- if 'user' in item -%}
       /home/{{ item.user }}/.ssh/known_hosts
      {%- elif 'path' in item -%}
       {{ item.path }}
      {%- else -%}
       ~/.ssh/known_hosts
      {%- endif -%}
    key: "{{ lookup('pipe', 'ssh-keyscan -p ' ~ (item.port | default(22) | string) ~ ' ' ~ item.host) }}"
  loop: "{{ common_users_known_hosts | default([]) }}"

- name: ðŸ§­ Add SSH Config Entries
  tags: [ssh, config]
  community.general.ssh_config:
    user: "{{ item.user }}"
    remote_user: "{{ item.remote_user | default(omit) }}"
    hostname: "{{ item.hostname }}"
    host: "{{ item.host }}"
    identity_file: "{{ item.identity_file }}"
    strict_host_key_checking: "{{ item.strict_host_key_checking | default(omit) }}"
    state: present
  loop: "{{ common_users_ssh_config | default([]) }}"

- name: ðŸ›¡ Configure Sudoers
  tags: [sudo, users]
  community.general.sudoers:
    name: "{{ item.user }}-run-as-{{ item.runas }}"
    user: "{{ item.user }}"
    runas: "{{ item.runas }}"
    commands: "{{ item.commands }}"
    nopassword: "{{ item.nopassword | default(omit) }}"
    setenv: "{{ item.setenv | default(omit) }}"
    state: present
  loop: "{{ common_users_sudoers | default([]) }}"
