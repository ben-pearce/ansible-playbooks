- name: üìÇ Include Deploy Variables
  tags: [vars, mailcow]
  ansible.builtin.include_vars:
    file: ../secrets/deploy/vars.yml

- name: üì¶ Install Expect
  tags: [packages, mailcow]
  ansible.builtin.apt:
    pkg:
      - expect
    state: present
    update_cache: true

- name: üîç Find Mailcow Backups
  tags: [backup, mailcow]
  ansible.builtin.find:
    paths: "{{ rc_mailcow_backup_dir }}"
    file_type: directory
    recurse: false
  register: rc_mailcow_backups

- name: üïí Select Latest Mailcow Backup
  tags: [backup, mailcow]
  ansible.builtin.set_fact:
    rc_latest_mailcow_backup: >-
      {{
        (
          rc_mailcow_backups.files |
          sort(attribute='mtime', reverse=true) |
          first
        ).path
      }}
  when: rc_mailcow_backups.files | length > 0

- name: üìù Template Mailcow Configuration
  tags: [config, mailcow]
  ansible.builtin.template:
    src: "{{ rc_mailcow_yaml_src }}"
    dest: "{{ rc_mailcow_container_path }}/mailcow.conf"
    owner: "{{ common_docker_compose_user.name }}"
    group: "{{ common_docker_compose_user.group }}"
    mode: "0600"

- name: ‚ñ∂Ô∏è Boot Mailcow Services
  tags: [docker, mailcow]
  community.docker.docker_compose_v2:
    project_src: "{{ rc_mailcow_container_path }}"
    wait: true

- name: ‚ôªÔ∏è Restore Mailcow Backup
  tags: [backup, mailcow]
  ansible.builtin.shell: |
    MAILCOW_BACKUP_LOCATION={{ rc_mailcow_backup_dir }} {{ common_docker_compose_directory }}/unattended_restore.expect
  register: rc_restore_mailcow_backup
  changed_when: rc_restore_mailcow_backup.rc != 0
  when: (rc_latest_mailcow_backup | default(None)) is not none

- name: ‚è≥ Start Certbot & Wait
  tags: [docker, certbot]
  community.docker.docker_compose_v2:
    project_src: "{{ common_docker_compose_directory }}"
    services: ["certbot"]
    wait: true

- name: üõ† Run Certbot Deploy Hook
  tags: [docker, certbot]
  community.docker.docker_container_exec:
    container: certbot
    command: /etc/letsencrypt/renewal-hooks/deploy/mailcow.sh

- name: üßπ Clean Mailcow Backups
  tags: [backup, cleanup]
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ rc_mailcow_backups.files }}"

- name: üóë Remove Expect
  tags: [packages, cleanup]
  ansible.builtin.apt:
    pkg:
      - expect
    state: absent
